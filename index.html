<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interaktyvus Geografijos Žemėlapis</title>
    
    <!-- Leaflet bibliotekos stiliai ir scenarijus iš CDN -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <style>
        html, body, #map {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
        }

        /* Legendos stilius */
        .legend-control {
            padding: 8px 12px;
            background-color: rgba(255, 255, 255, 0.9);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 8px;
            width: 220px; /* Sumažintas plotis */
            max-height: 80vh;
            overflow-y: auto;
        }

        .legend-control h1 {
            color: #1c1e21;
            border-bottom: 2px solid #f0f2f5;
            padding-bottom: 8px;
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.3em; /* Sumažintas šrifto dydis */
            text-align: center;
        }

        .control-group {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e0e0e0;
        }
        .control-group:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .control-item {
            display: block;
            margin-bottom: 5px;
            font-size: 1em;
        }
        .control-item:last-child {
            margin-bottom: 0;
        }

        .control-item label {
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
        }
        .control-item input {
            margin-right: 10px;
            transform: scale(1.1);
        }

        .leaflet-popup-content-wrapper {
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
        }
        .leaflet-popup-content {
            font-size: 1.1em;
            margin: 10px 15px !important;
            text-align: center;
            line-height: 1.4;
        }
        .popup-title {
            font-weight: bold;
            color: #0056b3;
            font-size: 1.2em;
        }
        .popup-description {
            font-size: 0.9em;
            color: #555;
        }
        .popup-info {
            font-size: 0.9em;
            color: #333;
            margin-top: 5px;
            font-style: italic;
        }

    </style>
</head>
<body>
    <div id="map"></div>

    <script>
    const cityData = [
        // Europa - Sostinės ir kiti miestai
        { lat: 52.3676, lng: 4.9041, name: "Amsterdamas", country: "Nyderlandai", type: "eu-cities", isCapital: true },
        { lat: 42.5063, lng: 1.5218, name: "Andora la Velja", country: "Andora", type: "eu-cities", isCapital: true },
        { lat: 39.9334, lng: 32.8597, name: "Ankara", country: "Turkija", type: "eu-cities", isCapital: true },
        { lat: 37.9838, lng: 23.7275, name: "Atėnai", country: "Graikija", type: "eu-cities", isCapital: true },
        { lat: 44.7866, lng: 20.4489, name: "Belgradas", country: "Serbija", type: "eu-cities", isCapital: true },
        { lat: 52.5200, lng: 13.4050, name: "Berlynas", country: "Vokietija", type: "eu-cities", isCapital: true },
        { lat: 46.9480, lng: 7.4474, name: "Bernas", country: "Šveicarija", type: "eu-cities", isCapital: true },
        { lat: 48.1486, lng: 17.1077, name: "Bratislava", country: "Slovakija", type: "eu-cities", isCapital: true },
        { lat: 50.8503, lng: 4.3517, name: "Briuselis", country: "Belgija", type: "eu-cities", isCapital: true },
        { lat: 47.4979, lng: 19.0402, name: "Budapeštas", country: "Vengrija", type: "eu-cities", isCapital: true },
        { lat: 44.4268, lng: 26.1025, name: "Bukareštas", country: "Rumunija", type: "eu-cities", isCapital: true },
        { lat: 53.3498, lng: -6.2603, name: "Dublinas", country: "Airija", type: "eu-cities", isCapital: true },
        { lat: 60.1699, lng: 24.9384, name: "Helsinkis", country: "Suomija", type: "eu-cities", isCapital: true },
        { lat: 50.4501, lng: 30.5234, name: "Kijevas", country: "Ukraina", type: "eu-cities", isCapital: true },
        { lat: 47.0105, lng: 28.8638, name: "Kišiniovas", country: "Moldova", type: "eu-cities", isCapital: true },
        { lat: 55.6761, lng: 12.5683, name: "Kopenhaga", country: "Danija", type: "eu-cities", isCapital: true },
        { lat: 38.7223, lng: -9.1393, name: "Lisabona", country: "Portugalija", type: "eu-cities", isCapital: true },
        { lat: 46.0569, lng: 14.5058, name: "Liubliana", country: "Slovėnija", type: "eu-cities", isCapital: true },
        { lat: 49.6116, lng: 6.1319, name: "Liuksemburgas", country: "Liuksemburgas", type: "eu-cities", isCapital: true },
        { lat: 51.5074, lng: -0.1278, name: "Londonas", country: "Jungtinė Karalystė", type: "eu-cities", isCapital: true },
        { lat: 40.4168, lng: -3.7038, name: "Madridas", country: "Ispanija", type: "eu-cities", isCapital: true },
        { lat: 53.9045, lng: 27.5615, name: "Minskas", country: "Baltarusija", type: "eu-cities", isCapital: true },
        { lat: 43.7384, lng: 7.4246, name: "Monakas", country: "Monakas", type: "eu-cities", isCapital: true },
        { lat: 55.7558, lng: 37.6173, name: "Maskva", country: "Rusija", type: "eu-cities", isCapital: true },
        { lat: 35.1264, lng: 33.4299, name: "Nikosija", country: "Kipras", type: "eu-cities", isCapital: true },
        { lat: 59.9139, lng: 10.7522, name: "Oslas", country: "Norvegija", type: "eu-cities", isCapital: true },
        { lat: 48.8566, lng: 2.3522, name: "Paryžius", country: "Prancūzija", type: "eu-cities", isCapital: true },
        { lat: 42.4304, lng: 19.2594, name: "Podgorica", country: "Juodkalnija", type: "eu-cities", isCapital: true },
        { lat: 50.0755, lng: 14.4378, name: "Praha", country: "Čekija", type: "eu-cities", isCapital: true },
        { lat: 64.1466, lng: -21.9426, name: "Reikjavikas", country: "Islandija", type: "eu-cities", isCapital: true },
        { lat: 56.9496, lng: 24.1052, name: "Ryga", country: "Latvija", type: "eu-cities", isCapital: true },
        { lat: 41.9028, lng: 12.4964, name: "Roma", country: "Italija", type: "eu-cities", isCapital: true },
        { lat: 43.9424, lng: 12.4578, name: "San Marinas", country: "San Marinas", type: "eu-cities", isCapital: true },
        { lat: 43.8563, lng: 18.4131, name: "Sarajevas", country: "Bosnija ir Hercegovina", type: "eu-cities", isCapital: true },
        { lat: 42.0024, lng: 21.4375, name: "Skopjė", country: "Šiaurės Makedonija", type: "eu-cities", isCapital: true },
        { lat: 42.6977, lng: 23.3219, name: "Sofija", country: "Bulgarija", type: "eu-cities", isCapital: true },
        { lat: 59.3293, lng: 18.0686, name: "Stokholmas", country: "Švedija", type: "eu-cities", isCapital: true },
        { lat: 59.4370, lng: 24.7536, name: "Talinas", country: "Estija", type: "eu-cities", isCapital: true },
        { lat: 41.7151, lng: 44.8271, name: "Tbilisis", country: "Gruzija", type: "eu-cities", isCapital: true },
        { lat: 41.3275, lng: 19.8187, name: "Tirana", country: "Albanija", type: "eu-cities", isCapital: true },
        { lat: 35.8989, lng: 14.5146, name: "Valeta", country: "Malta", type: "eu-cities", isCapital: true },
        { lat: 52.2297, lng: 21.0122, name: "Varšuva", country: "Lenkija", type: "eu-cities", isCapital: true },
        { lat: 48.2082, lng: 16.3738, name: "Viena", country: "Austrija", type: "eu-cities", isCapital: true },
        { lat: 45.8150, lng: 15.9819, name: "Zagrebas", country: "Kroatija", type: "eu-cities", isCapital: true },
        { lat: 41.3851, lng: 2.1734, name: "Barselona", country: "Ispanija", type: "eu-cities", isCapital: false },
        { lat: 50.1109, lng: 8.6821, name: "Frankfurtas prie Maino", country: "Vokietija", type: "eu-cities", isCapital: false },
        { lat: 53.5511, lng: 9.9937, name: "Hamburgas", country: "Vokietija", type: "eu-cities", isCapital: false },
        { lat: 50.0647, lng: 19.9450, name: "Krokuva", country: "Lenkija", type: "eu-cities", isCapital: false },
        { lat: 40.8518, lng: 14.2681, name: "Neapolis", country: "Italija", type: "eu-cities", isCapital: false },
        { lat: 59.9311, lng: 30.3609, name: "Sankt Peterburgas", country: "Rusija", type: "eu-cities", isCapital: false },
        { lat: 41.0082, lng: 28.9784, name: "Stambulas", country: "Turkija", type: "eu-cities", isCapital: false },
        { lat: 48.5734, lng: 7.7521, name: "Strasbūras", country: "Prancūzija", type: "eu-cities", isCapital: false },
        { lat: 45.4408, lng: 12.3155, name: "Venecija", country: "Italija", type: "eu-cities", isCapital: false },
        
        // Lietuva
        { lat: 54.6872, lng: 25.2797, name: "Vilnius", country: "Lietuva", type: "lt-cities", isCapital: true },
        { lat: 54.3963, lng: 24.0481, name: "Alytus", country: "Lietuva", type: "lt-cities", isCapital: false },
        { lat: 54.8985, lng: 23.9036, name: "Kaunas", country: "Lietuva", type: "lt-cities", isCapital: false },
        { lat: 55.7033, lng: 21.1443, name: "Klaipėda", country: "Lietuva", type: "lt-cities", isCapital: false },
        { lat: 55.7330, lng: 24.3500, name: "Panevėžys", country: "Lietuva", type: "lt-cities", isCapital: false },
        { lat: 55.9333, lng: 23.3167, name: "Šiauliai", country: "Lietuva", type: "lt-cities", isCapital: false },

        // Azija
        { lat: 24.4539, lng: 54.3773, name: "Abu Dabis", country: "JAE", type: "as-cities", isCapital: true },
        { lat: 33.3152, lng: 44.3661, name: "Bagdadas", country: "Irakas", type: "as-cities", isCapital: true },
        { lat: 13.7563, lng: 100.5018, name: "Bankokas", country: "Tailandas", type: "as-cities", isCapital: true },
        { lat: 33.5138, lng: 36.2765, name: "Damaskas", country: "Sirija", type: "as-cities", isCapital: true },
        { lat: 28.6139, lng: 77.2090, name: "Delis", country: "Indija", type: "as-cities", isCapital: true },
        { lat: -6.2088, lng: 106.8456, name: "Džakarta", country: "Indonezija", type: "as-cities", isCapital: true },
        { lat: 31.7683, lng: 35.2137, name: "Jeruzalė", country: "Izraelis", type: "as-cities", isCapital: true },
        { lat: 29.3759, lng: 47.9774, name: "Kuveitas", country: "Kuveitas", type: "as-cities", isCapital: true },
        { lat: 51.1694, lng: 71.4491, name: "Nursultanas", country: "Kazachstanas", type: "as-cities", isCapital: true },
        { lat: 39.9042, lng: 116.4074, name: "Pekinas", country: "Kinija", type: "as-cities", isCapital: true },
        { lat: 24.7136, lng: 46.6753, name: "Rijadas", country: "Saudo Arabija", type: "as-cities", isCapital: true },
        { lat: 35.6892, lng: 51.3890, name: "Teheranas", country: "Iranas", type: "as-cities", isCapital: true },
        { lat: 35.6762, lng: 139.6503, name: "Tokijas", country: "Japonija", type: "as-cities", isCapital: true },
        { lat: 25.2048, lng: 55.2708, name: "Dubajus", country: "JAE", type: "as-cities", isCapital: false },
        { lat: 22.3193, lng: 114.1694, name: "Honkongas", country: "Kinija", type: "as-cities", isCapital: false },
        { lat: 19.0760, lng: 72.8777, name: "Mumbajus", country: "Indija", type: "as-cities", isCapital: false },
        { lat: 31.2304, lng: 121.4737, name: "Šanchajus", country: "Kinija", type: "as-cities", isCapital: false },
        { lat: 32.0853, lng: 34.7818, name: "Tel Avivas", country: "Izraelis", type: "as-cities", isCapital: false },

        // Šiaurės Amerika
        { lat: 19.4326, lng: -99.1332, name: "Meksikas", country: "Meksika", type: "na-cities", isCapital: true },
        { lat: 45.4215, lng: -75.6972, name: "Otava", country: "Kanada", type: "na-cities", isCapital: true },
        { lat: 38.9072, lng: -77.0369, name: "Vašingtonas", country: "JAV", type: "na-cities", isCapital: true },
        { lat: 41.8781, lng: -87.6298, name: "Čikaga", country: "JAV", type: "na-cities", isCapital: false },
        { lat: 34.0522, lng: -118.2437, name: "Los Andželas", country: "JAV", type: "na-cities", isCapital: false },
        { lat: 40.7128, lng: -74.0060, name: "Niujorkas", country: "JAV", type: "na-cities", isCapital: false },
        { lat: 37.7749, lng: -122.4194, name: "San Fransiskas", country: "JAV", type: "na-cities", isCapital: false },
        { lat: 43.6532, lng: -79.3832, name: "Torontas", country: "Kanada", type: "na-cities", isCapital: false },

        // Pietų Amerika
        { lat: 4.7110, lng: -74.0721, name: "Bogota", country: "Kolumbija", type: "sa-cities", isCapital: true },
        { lat: -15.8267, lng: -47.9218, name: "Brazilija", country: "Brazilija", type: "sa-cities", isCapital: true },
        { lat: -34.6037, lng: -58.3816, name: "Buenos Airės", country: "Argentina", type: "sa-cities", isCapital: true },
        { lat: 10.4806, lng: -66.9036, name: "Karakasas", country: "Venesuela", type: "sa-cities", isCapital: true },
        { lat: -12.0464, lng: -77.0428, name: "Lima", country: "Peru", type: "sa-cities", isCapital: true },
        { lat: -33.4489, lng: -70.6693, name: "Santjagas", country: "Čilė", type: "sa-cities", isCapital: true },
        { lat: -3.1190, lng: -60.0217, name: "Manausas", country: "Brazilija", type: "sa-cities", isCapital: false },
        { lat: -22.9068, lng: -43.1729, name: "Rio de Žaneiras", country: "Brazilija", type: "sa-cities", isCapital: false },
        { lat: -23.5505, lng: -46.6333, name: "San Paulas", country: "Brazilija", type: "sa-cities", isCapital: false },

        // Afrika
        { lat: 9.0765, lng: 7.3986, name: "Abudža", country: "Nigerija", type: "af-cities", isCapital: true },
        { lat: 9.03, lng: 38.74, name: "Adis Abeba", country: "Etiopija", type: "af-cities", isCapital: true },
        { lat: 30.0444, lng: 31.2357, name: "Kairas", country: "Egiptas", type: "af-cities", isCapital: true },
        { lat: -33.9249, lng: 18.4241, name: "Keiptaunas", country: "Pietų Afrika", type: "af-cities", isCapital: true },
        { lat: -4.4419, lng: 15.2663, name: "Kinšasa", country: "Kongo DR", type: "af-cities", isCapital: true },
        { lat: -26.2041, lng: 28.0473, name: "Johanesburgas", country: "Pietų Afrika", type: "af-cities", isCapital: false },
        { lat: 6.5244, lng: 3.3792, name: "Lagosas", country: "Nigerija", type: "af-cities", isCapital: false },

        // Australija ir Okeanija
        { lat: -35.2809, lng: 149.1300, name: "Kanbera", country: "Australija", type: "au-cities", isCapital: true },
        { lat: -41.2865, lng: 174.7762, name: "Velingtonas", country: "Naujoji Zelandija", type: "au-cities", isCapital: true },
        { lat: -37.8136, lng: 144.9631, name: "Melburnas", country: "Australija", type: "au-cities", isCapital: false },
        { lat: -33.8688, lng: 151.2093, name: "Sidnėjus", country: "Australija", type: "au-cities", isCapital: false },

        // Verta Žinoti
        { lat: 52.3676, lng: 4.9041, name: "Amsterdamas", country: "Nyderlandai", type: "info", info: "Inovatyvių urbanistinių ir ekologinių sprendimų pavyzdys." },
        { lat: 55.5260, lng: 25.1060, name: "Anykščiai", country: "Lietuva", type: "info", info: "Istorinis kvarcinio smėlio gavybos centras." },
        { lat: 43.2565, lng: -2.9236, name: "Bilbao", country: "Ispanija", type: "info", info: "Sėmingos miesto transformacijos pavyzdys." },
        { lat: 54.6050, lng: 24.0320, name: "Birštonas", country: "Lietuva", type: "info", info: "Mineralinio vandens ir purvo kurortas." },
        { lat: 51.3896, lng: 30.0993, name: "Černobilis (Pripetė)", country: "Ukraina", type: "info", info: "Didžiausios branduolinės avarijos vieta." },
        { lat: 54.0167, lng: 23.9667, name: "Druskininkai", country: "Lietuva", type: "info", info: "Mineralinio vandens ir purvo kurortas." },
        { lat: 56.2403, lng: 23.6150, name: "Joniškis", country: "Lietuva", type: "info", info: "Dolomito gavybos regionas." },
        { lat: 56.2628, lng: 24.6339, name: "Karvės ola", country: "Lietuva", type: "info", info: "Karstinės įgriuvos pavyzdys." },
        { lat: 55.7060, lng: 21.1200, name: "Klaipėdos uostas", country: "Lietuva", type: "info", info: "Strateginis jūrų uostas ir transporto mazgas." },
        { lat: 56.3130, lng: 22.3360, name: "Mažeikiai", country: "Lietuva", type: "info", info: "Naftos perdirbimo pramonės centras." },
        { lat: 56.3210, lng: 22.8830, name: "Naujoji Akmenė", country: "Lietuva", type: "info", info: "Cemento pramonės centras." },
        { lat: 55.7890, lng: 21.0800, name: "Olando kepurės skardis", country: "Lietuva", type: "info", info: "Abrazinio kranto (skardžio) pavyzdys." },
        { lat: 54.6860, lng: 25.3470, name: "Pūčkorių atodanga", country: "Lietuva", type: "info", info: "Ledynmečio ir tarpledynmečio nuogulų atodanga." },
        { lat: 51.4556, lng: 7.0116, name: "Rūro sritis", country: "Vokietija", type: "info", info: "Senosios industrializacijos regiono pavyzdys." },
        { lat: 55.8570, lng: 22.5600, name: "Šatrijos kalnas", country: "Lietuva", type: "info", info: "Ledyno suformuotos kalvos (kamo) pavyzdys." },
        { lat: 55.5920, lng: 26.4300, name: "Visaginas", country: "Lietuva", type: "info", info: "Mono-funkcinis miestas (atominė elektrinė)." },
        { lat: 46.4057, lng: 64.0416, name: "Aralskas", country: "Kazachstanas", type: "info", info: "Esminis ekologinės katastrofos pavyzdys." },
        { lat: 23.8103, lng: 90.4125, name: "Daka", country: "Bangladešas", type: "info", info: "Daugiau nei 20 mln gyventojų." },
        { lat: 19.0213, lng: 72.8424, name: "Dharavis (Mumbajus)", country: "Indija", type: "info", info: "Vienas didžiausių pasaulyje lušnynų." },
        { lat: 37.7503, lng: 140.4676, name: "Fukušima", country: "Japonija", type: "info", info: "Branduolinės avarijos po cunamio pavyzdys." },
        { lat: 31.8698, lng: 35.4549, name: "Jerichas", country: "Vakarų Krantas", type: "info", info: "Vienas seniausių pasaulio miestų." },
        { lat: 24.8607, lng: 67.0011, name: "Karačis", country: "Pakistanas", type: "info", info: "Vienas didžiausių Pasaulio miestų." },
        { lat: 43.0801, lng: 58.2093, name: "Muinakas", country: "Uzbekistanas", type: "info", info: "Garsėja kaip 'laivų kapinės'." },
        { lat: 22.5431, lng: 114.0579, name: "Šendženas", country: "Kinija", type: "info", info: "Spartaus ekonominio augimo ir urbanizacijos pavyzdys." },
        { lat: 42.0987, lng: -83.0364, name: "Detroitas", country: "JAV", type: "info", info: "Miesto nuosmukio ir deindustrializacijos pavyzdys." },
        { lat: 29.9511, lng: -90.0715, name: "Naujasis Orleanas", country: "JAV", type: "info", info: "Gamtinių katastrofų konteksto pavyzdys." },
        { lat: 37.4419, lng: -122.1430, name: "Silicio slėnis", country: "JAV", type: "info", info: "Inovacijų ir technologijų centro pavyzdys." },
        { lat: -22.9885, lng: -43.2452, name: "Favelos (Rocinha)", country: "Brazilija", type: "info", info: "Lušnynų pavyzdys Lotynų Amerikos didmiesčiuose." },
        { lat: -25.4284, lng: -49.2733, name: "Kuritiba", country: "Brazilija", type: "info", info: "Tvaraus miesto planavimo pavyzdys." },
        { lat: 6.2442, lng: -75.5812, name: "Medeljinas", country: "Kolumbija", type: "info", info: "Sėmingos socialinės transformacijos pavyzdys." },
        { lat: 9.0765, lng: 7.3986, name: "Abudža", country: "Nigerija", type: "info", info: "Vienas sparčiausiai augančių miestų ne tik Afrikoje, bet ir visame pasaulyje." },
        { lat: 9.03, lng: 38.74, name: "Adis Abeba", country: "Etiopija", type: "info", info: "Sparčiai augantis miestas, diplomatikos ir transporto mazgas." },
        { lat: 31.2001, lng: 29.9187, name: "Aleksandrija", country: "Egiptas", type: "info", info: "Antrasis pagal gyventojų skaičių ir ekonominę reikšmę istorinis Egipto miestas." },
        { lat: -1.3149, lng: 36.7793, name: "Kibera (Nairobis)", country: "Kenija", type: "info", info: "Vienas didžiausių Afrikos lušnynų." },
        { lat: -4.4419, lng: 15.2663, name: "Kinšasa", country: "Kongo DR", type: "info", info: "Vienas sparčiausiai augančių megamiestų pasaulyje." },
        { lat: 15.3000, lng: -1.5000, name: "Sahelio zona", country: "Afrika", type: "info", info: "Dykumėjimo ir klimato kaitos poveikio regionas." },
        { lat: -8.5188, lng: 179.1983, name: "Funafutis", country: "Tuvalu", type: "info", info: "Klimato kaitos padarinių ir jūros lygio kilimo pavyzdys." },
        { lat: -0.5270, lng: 166.9315, name: "Jarenas", country: "Nauru", type: "info", info: "Fosfatų gavybos padarinių pavyzdys." },
        { lat: 1.3278, lng: 172.9796, name: "Tarava", country: "Kiribatis", type: "info", info: "Klimato kaitos padarinių ir jūros lygio kilimo pavyzdys." },
        { lat: 31.4167, lng: 34.3333, name: "Gaza (Gazos Ruožas)", country: "Palestina", type: "info", info: "Palestinos autonomijos dalis." },
        { lat: 32.0819, lng: 35.3283, name: "Vakarų Krantas", country: "Palestina", type: "info", info: "Palestinos autonomijos regionas, apimantis Rytų Jeruzalę." }
    ];
    
    const map = L.map('map', {
        center: [45, 20],
        zoom: 3,
        zoomControl: false // Išjungiame numatytąjį priartinimo valdymą
    });

    // Sukuriame atskirą sritį (pane) valstybių sluoksniui, kad jis būtų po miestais
    map.createPane('statesPane');
    map.getPane('statesPane').style.zIndex = 450; // Numatytasis žymeklių zIndex yra 600

    // Pridedame priartinimo valdymą kitoje pozicijoje
    L.control.zoom({ position: 'topleft' }).addTo(map);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
    }).addTo(map);

    let statesLayer, cityLayers = {};
    
    // Žodynas šalies pavadinimui paversti kilmininko linksniu
    const countryGenitives = {
        "Nyderlandai": "Nyderlandų", "Andora": "Andoros", "Turkija": "Turkijos", "Graikija": "Graikijos", "Serbija": "Serbijos", "Vokietija": "Vokietijos", "Šveicarija": "Šveicarijos", "Slovakija": "Slovakijos", "Belgija": "Belgijos", "Vengrija": "Vengrijos", "Rumunija": "Rumunijos", "Airija": "Airijos", "Suomija": "Suomijos", "Ukraina": "Ukrainos", "Moldova": "Moldovos", "Danija": "Danijos", "Portugalija": "Portugalijos", "Slovėnija": "Slovėnijos", "Liuksemburgas": "Liuksemburgo", "Jungtinė Karalystė": "Jungtinės Karalystės", "Ispanija": "Ispanijos", "Baltarusija": "Baltarusijos", "Monakas": "Monako", "Rusija": "Rusijos", "Kipras": "Kipro", "Norvegija": "Norvegijos", "Prancūzija": "Prancūzijos", "Juodkalnija": "Juodkalnijos", "Čekija": "Čekijos", "Islandija": "Islandijos", "Latvija": "Latvijos", "Italija": "Italijos", "San Marinas": "San Marino", "Bosnija ir Hercegovina": "Bosnijos ir Hercegovinos", "Šiaurės Makedonija": "Šiaurės Makedonijos", "Bulgarija": "Bulgarijos", "Švedija": "Švedijos", "Estija": "Estijos", "Gruzija": "Gruzijos", "Albanija": "Albanijos", "Malta": "Maltos", "Lenkija": "Lenkijos", "Austrija": "Austrijos", "Lietuva": "Lietuvos", "Kroatija": "Kroatijos", "JAE": "JAE", "Irakas": "Irako", "Tailandas": "Tailando", "Sirija": "Sirijos", "Indija": "Indijos", "Indonezija": "Indonezijos", "Izraelis": "Izraelio", "Kuveitas": "Kuveito", "Omanas": "Omano", "Kazachstanas": "Kazachstano", "Kinija": "Kinijos", "Saudo Arabija": "Saudo Arabijos", "Iranas": "Irano", "Japonija": "Japonijos", "Meksika": "Meksikos", "Kanada": "Kanados", "JAV": "JAV", "Kolumbija": "Kolumbijos", "Brazilija": "Brazilijos", "Argentina": "Argentinos", "Venesuela": "Venesuelos", "Peru": "Peru", "Čilė": "Čilės", "Nigerija": "Nigerijos", "Etiopija": "Etiopijos", "Egiptas": "Egipto", "Pietų Afrika": "Pietų Afrikos", "Kongo DR": "Kongo DR", "Australija": "Australijos", "Naujoji Zelandija": "Naujosios Zelandijos"
    };

    // Pagalbinė funkcija iššokančių langų turiniui kurti
    function createPopupContent(data) {
        let title = `<div class="popup-title">${data.name}</div>`;
        let description = '';
        if (data.info) {
            description = `<div class="popup-info">${data.info}</div>`;
        } else {
            const genitiveCountry = countryGenitives[data.country] || data.country;
            let typeText = data.isCapital ? "sostinė" : "miestas";
            if (data.country === "Lietuva" && (data.name.includes("uostas") || data.name.includes("skardis") || data.name.includes("atodanga") || data.name.includes("kalnas") || data.name.includes("ola"))) {
               typeText = "objektas";
            }
            description = `<div class="popup-description">(${genitiveCountry} ${typeText})</div>`;
        }
        return title + description;
    }
    
    // Legendos (valdymo skydelio) sukūrimas ant žemėlapio
    const LegendControl = L.Control.extend({
        onAdd: function(map) {
            const container = L.DomUtil.create('div', 'legend-control');
            L.DomEvent.disableClickPropagation(container);
            container.innerHTML = `
                <h1>Ką mokytis?</h1>
                <div class="control-group">
                    <div class="control-item">
                        <label><input type="checkbox" id="states-cb" >Valstybės</label>
                    </div>
                </div>
                <div class="control-group">
                    <div class="control-item">
                        <label><input type="checkbox" id="lt-cities-cb" >Lietuvos miestai</label>
                    </div>
                </div>
                <div class="control-group">
                    <div class="control-item">
                        <label><input type="checkbox" id="eu-cities-cb" >Europos miestai</label>
                    </div>
                </div>
                <div class="control-group">
                    <div class="control-item">
                        <label><input type="checkbox" id="as-cities-cb" >Azijos miestai</label>
                    </div>
                </div>
                <div class="control-group">
                    <div class="control-item">
                        <label><input type="checkbox" id="na-cities-cb" >Š. Amerikos miestai</label>
                    </div>
                </div>
                <div class="control-group">
                    <div class="control-item">
                        <label><input type="checkbox" id="sa-cities-cb" >P. Amerikos miestai</label>
                    </div>
                </div>
                <div class="control-group">
                    <div class="control-item">
                        <label><input type="checkbox" id="af-cities-cb" >Afrikos miestai</label>
                    </div>
                </div>
                <div class="control-group">
                    <div class="control-item">
                        <label><input type="checkbox" id="au-cities-cb" >Australijos ir Okeanijos miestai</label>
                    </div>
                </div>
                <div class="control-group">
                    <div class="control-item">
                        <label><input type="checkbox" id="info-cb" >Verta žinoti</label>
                    </div>
                </div>
            `;
            return container;
        }
    });
    new LegendControl({ position: 'topright' }).addTo(map);

    // Sluoksnių inicializavimas
    const layerTypes = ["lt-cities", "eu-cities", "as-cities", "na-cities", "sa-cities", "af-cities", "au-cities", "info"];
    layerTypes.forEach(type => cityLayers[type] = L.layerGroup());

    cityData.forEach(city => {
        const marker = L.circleMarker([city.lat, city.lng], {
            radius: city.type === 'info' ? 7 : 5,
            fillColor: city.type === 'info' ? "#e63946" : "#0077b6",
            color: "#000",
            weight: 1,
            opacity: 1,
            fillOpacity: 0.8
        });
        marker.bindPopup(createPopupContent(city));
        if(cityLayers[city.type]) {
            cityLayers[city.type].addLayer(marker);
        }
    });

    // Valstybių sluoksnio paruošimas
    async function setupStatesLayer() {
        try {
            const response = await fetch('https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json');
            const data = await response.json();
            const countriesToLearnSet = new Set(["Afghanistan", "Algeria", "Argentina", "Australia", "Bangladesh", "Brazil", "Canada", "Chad", "Chile", "China", "Colombia", "Cuba", "Cyprus", "Dem. Rep. Congo", "Egypt", "Ethiopia", "Georgia", "Haiti", "India", "Indonesia", "Iran", "Iraq", "Israel", "Japan", "Kazakhstan", "Kenya", "Kuwait", "Libya", "Madagascar", "Malaysia", "Mexico", "Mongolia", "Morocco", "Nepal", "New Zealand", "Nigeria", "North Korea", "Oman", "Pakistan", "Panama", "Peru", "Philippines", "Qatar", "Russia", "Saudi Arabia", "Singapore", "Somalia", "South Africa", "South Korea", "S. Sudan", "Sri Lanka", "Syria", "Thailand", "Tunisia", "Turkey", "United Arab Emirates", "United States of America", "Venezuela", "Vietnam", "Yemen", "Albania", "Andorra", "Austria", "Belarus", "Belgium", "Bosnia and Herz.", "Bosnia and Herzegovina", "Bulgaria", "Croatia", "Czechia", "Czech Republic", "Denmark", "Estonia", "Finland", "France", "Germany", "Greece", "Hungary", "Iceland", "Ireland", "Italy", "Kosovo", "Latvia", "Liechtenstein", "Lithuania", "Luxembourg", "Malta", "Moldova", "Monaco", "Montenegro", "Netherlands", "Macedonia", "Norway", "Poland", "Portugal", "Romania", "San Marino", "Serbia", "Republic of Serbia", "Slovakia", "Slovenia", "Spain", "Sweden", "Switzerland", "Ukraine", "United Kingdom", "Vatican"]);
            
            // Pridedame lietuviškus pavadinimus į duomenis
            const countryNamesLT = {"Afghanistan":"Afganistanas","Angola":"Angola","Albania":"Albanija","United Arab Emirates":"Jungtiniai Arabų Emyratai","Argentina":"Argentina","Armenia":"Armėnija","Antarctica":"Antarktida","Fr. S. Antarctic Lands":"Prancūzijos Pietų Sritys","Australia":"Australija","Austria":"Austrija","Azerbaijan":"Azerbaidžanas","Andora":"Andora","Burundi":"Burundis","Belgium":"Belgija","Benin":"Beninas","Burkina Faso":"Burkina Fasas","Bangladesh":"Bangladešas","Bulgaria":"Bulgarija","Bahamas":"Bahamos","Bosnia and Herz.":"Bosnija ir Hercegovina","Bosnia and Herzegovina":"Bosnija ir Hercegovina","Belarus":"Baltarusija","Belize":"Belizas","Bolivia":"Bolivija","Brazil":"Brazilija","Brunei":"Brunėjus","Bhutan":"Butanas","Botswana":"Botsvana","Central African Rep.":"Centrinės Afrikos Respublika","Canada":"Kanada","Switzerland":"Šveicarija","Chile":"Čilė","China":"Kinija","Côte d'Ivoire":"Dramblio Kaulo Krantas","Cameroon":"Kamerūnas","Dem. Rep. Congo":"Kongo Demokratinė Respublika","Congo":"Kongas","Colombia":"Kolumbija","Costa Rica":"Kosta Rika","Cuba":"Kuba","N. Cyprus":"Šiaurės Kipras","Cyprus":"Kipras","Czechia":"Čekija","Czech Republic":"Čekija","Germany":"Vokietija","Djibouti":"Džibutis","Denmark":"Danija","Dominican Rep.":"Dominikos Respublika","Algeria":"Alžyras","Ecuador":"Ekvadoras","Egypt":"Egiptas","Eritrea":"Eritrėja","Spain":"Ispanija","Estonia":"Estija","Ethiopia":"Etiopija","Finland":"Suomija","Fiji":"Fidžis","Falkland Is.":"Falklando salos","France":"Prancūzija","Gabon":"Gabonas","United Kingdom":"Jungtinė Karalystė","Georgia":"Gruzija","Ghana":"Gana","Guinea":"Gvinėja","Gambia":"Gambija","Guinea-Bissau":"Bisau Gvinėja","Eq. Guinea":"Pusiaujo Gvinėja","Greece":"Graikija","Greenland":"Grenlandija","Guatemala":"Gvatemala","Guyana":"Gajana","Honduras":"Hondūras","Croatia":"Kroatija","Haiti":"Haitis","Hungary":"Vengrija","Indonesia":"Indonezija","India":"Indija","Ireland":"Airija","Iran":"Iranas","Iraq":"Irakas","Iceland":"Islandija","Israel":"Izraelis","Italy":"Italija","Jamaica":"Jamaika","Jordan":"Jordanija","Japan":"Japonija","Kazakhstan":"Kazachstanas","Kenya":"Kenija","Kyrgyzstan":"Kirgizija","Cambodia":"Kambodža","South Korea":"Pietų Korėja","Kosovo":"Kosovas","Kuwait":"Kuveitas","Laos":"Laosas","Lebanon":"Libanas","Liberia":"Liberija","Libya":"Libija","Sri Lanka":"Šri Lanka","Lesotho":"Lesotas","Lithuania":"Lietuva","Luxembourg":"Liuksemburgas","Latvia":"Latvija","Liechtenstein":"Lichtenšteinas","Morocco":"Marokas","Moldova":"Moldova","Madagascar":"Madagaskaras","Mexico":"Meksika","Macedonia":"Šiaurės Makedonija","Mali":"Malis","Malta":"Malta","Myanmar":"Mianmaras","Montenegro":"Juodkalnija","Monaco":"Monakas","Mongolia":"Mongolija","Mozambique":"Mozambikas","Mauritania":"Mauritanija","Malawi":"Malavis","Malaysia":"Malaizija","Namibia":"Namibija","New Caledonia":"Naujoji Kaledonija","Niger":"Nigeris","Nigeria":"Nigerija","Nicaragua":"Nikaragva","Netherlands":"Nyderlandai","Norway":"Norvegija","Nepal":"Nepalas","New Zealand":"Naujoji Zelandija","Oman":"Omanas","Pakistan":"Pakistanas","Panama":"Panama","Peru":"Peru","Philippines":"Filipinai","Papua New Guinea":"Papua Naujoji Gvinėja","Poland":"Lenkija","Puerto Rico":"Puerto Rikas","North Korea":"Šiaurės Korėja","Portugal":"Portugalija","Paraguay":"Paragvajus","Palestine":"Palestina","Qatar":"Kataras","Romania":"Rumunija","Russia":"Rusija","Rwanda":"Ruanda","W. Sahara":"Vakarų Sachara","Saudi Arabia":"Saudo Arabija","Sudan":"Sudanas","S. Sudan":"Pietų Sudanas","Senegal":"Senegalas","Solomon Is.":"Saliamono salos","Sierra Leone":"Siera Leonė","El Salvador":"Salvadoras","San Marino":"San Marinas","Somaliland":"Somalilandas","Somalia":"Somalis","Serbia":"Serbija","Republic of Serbia":"Serbija","Singapore":"Singapūras","Suriname":"Surinamas","Slovakia":"Slovakija","Slovenia":"Slovėnija","Sweden":"Švedija","Swaziland":"Esvatinis","Syria":"Sirija","Chad":"Čadas","Togo":"Togas","Thailand":"Tailandas","Tajikistan":"Tadžikistanas","Turkmenistan":"Turkmėnistanas","Timor-Leste":"Rytų Timoras","Trinidad and Tobago":"Trinidadas ir Tobagas","Tunisia":"Tunisas","Turkey":"Turkija","Taiwan":"Taivanas","Tanzania":"Tanzanija","Uganda":"Uganda","Ukraine":"Ukraina","Uruguay":"Urugvajus","United States of America":"Jungtinės Amerikos Valstijos","Uzbekistan":"Uzbekistanas","Venezuela":"Venesuela","Vietnam":"Vietnamas","Vanuatu":"Vanuatu","Vatican":"Vatikano Miesto Valstybė","Yemen":"Jemenas","South Africa":"Pietų Afrika","Zambia":"Zambija","Zimbabwe":"Zimbabvė"};
            data.features.forEach(feature => {
                const englishName = feature.properties.name;
                feature.properties.name_lt = countryNamesLT[englishName] || englishName;
            });

            statesLayer = L.geoJSON(data, {
                pane: 'statesPane', // Nurodome, kad valstybių sluoksnis turi būti "statesPane" srityje
                style: feature => ({
                    fillColor: countriesToLearnSet.has(feature.properties.name) ? '#FFC107' : '#E0E0E0',
                    weight: 1,
                    opacity: 1,
                    color: '#888',
                    fillOpacity: 0.6
                }),
                onEachFeature: (feature, layer) => {
                    if (feature.properties && feature.properties.name_lt) {
                        layer.bindPopup(`<div class="popup-title">${feature.properties.name_lt}</div>`);
                    }
                }
            });
        } catch (error) {
            console.error("Klaida gaunant valstybių duomenis:", error);
        }
    }
    
    // Įvykių klausytojai (turi būti priskirti PO to, kai sukuriamas HTML turinys)
    map.whenReady(async () => {
        // Pirmiausia paruošiame valstybių sluoksnį, kad jis būtų pasiekiamas
        await setupStatesLayer();

        const layerMapping = {
            'states-cb': statesLayer,
            'lt-cities-cb': cityLayers['lt-cities'],
            'eu-cities-cb': cityLayers['eu-cities'],
            'as-cities-cb': cityLayers['as-cities'],
            'na-cities-cb': cityLayers['na-cities'],
            'sa-cities-cb': cityLayers['sa-cities'],
            'af-cities-cb': cityLayers['af-cities'],
            'au-cities-cb': cityLayers['au-cities'],
            'info-cb': cityLayers['info']
        };

        for (const [id, layer] of Object.entries(layerMapping)) {
            const checkbox = document.getElementById(id);
            if (checkbox) {
                // Patikriname pradinę būseną (dabar visada bus nepažymėta)
                if (checkbox.checked && layer) {
                    map.addLayer(layer);
                }
                
                // Pridedame įvykio klausytoją
                checkbox.addEventListener('change', e => {
                    if (layer) {
                        e.target.checked ? map.addLayer(layer) : map.removeLayer(layer);
                    }
                });
            }
        }
    });

    </script>
</body>
</html>

